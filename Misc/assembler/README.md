# `lc3asm`: Python 的 LC-3 汇编器实现

**taoky**

## 安装、使用与测试

### 安装

该项目依赖：

- Python 3.7+
- `regex`: 第三方正则表达式库

使用 `pip install -r requirements.txt` 安装依赖

### 使用

在命令行下运行 `./lc3asm [你的汇编程序文件路径]`。

若环境变量中定义了 `DEBUG`，则会输出详细的内容。如果在汇编过程中出现问题，程序会抛出异常并退出。如果没有问题，最后会在汇编程序路径下生成 `[汇编程序文件名].o`，为最终生成的目标文件。

生成的目标文件如果需要在 `lc3sim` 下运行，需要更改扩展名至 `obj`。

### 测试

`test.sh` 为测试脚本。其将 `test/` 目录下所有的 `asm` 文件分别使用 `lc3as` 与本汇编器汇编，比较输出结果。

如果需要使用，需要将 `~/Tools/lc3tools/lc3as` 更改为自己的 `lc3as` 的路径。

在 macOS 10.13，Python 3.7.0 下测试通过。

## 特性支持

该汇编器支持：

- 表格 A.1 中所有除 reserved 的指令。
  - 所有使用了 LABEL 的指令对应部分都可以用代表 `PC` 偏移量的立即数代替。
- 表格 A.2 中所有的 Trap Service Routines。
- 除了 `.EXTERNAL` 以外的伪指令。
  - `.FILL` 支持使用 LABEL。
  - `.STRINGZ` 支持所有 Python 支持的转义字符与 `\e`、`\E`。
- LABEL、指令、寄存器、立即数都是大小写不敏感的。

不支持：

- 符号表输出至 `sym` 文件。在启用了 `DEBUG` 时，调试输出包含了符号表。
- 同一行中包含两个及以上的 LABEL 是不允许的。

## 大致思路

扫描两遍文件。

### PASS 1

提取符号表。`utils.py` 中包含了一些子正则字符串，包含了空白字符、标签、注释等的判断。在 `assemble.py` 中在 `match_dict` 中拼接这些字符串构成一系列规则。

首先寻找 `.ORIG`，提取起始地址。之后对每一行对应不同规则查找，如果有 LABEL，就提取出来，加入返回字典。

如果某行无法被任意规则匹配，抛出异常。

### PASS 2

根据符号表填内容：根据不同的规则 + 位运算填编码，以大端序写入文件。其中包含对操作数合法性的判断。

## Credits

感谢 @iBug 同学对 `assemble.py` 中使用 `namedtuple` 以支持 `compiled.xxxx` 语法的小技巧和测试脚本的一部分的贡献。